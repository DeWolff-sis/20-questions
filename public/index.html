<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>20Q Multiplayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 12px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    main {
      flex: 1;
      padding: 16px;
      max-width: 900px;
      margin: auto;
      width: 100%;
    }
    .hidden { display: none !important; }
    .row { display: flex; gap: 8px; margin: 8px 0; flex-wrap: wrap; }
    .log, .chat {
      border: 1px solid #ccc;
      border-radius: 8px;
      background: white;
      padding: 8px;
      height: 200px;
      overflow-y: auto;
      margin: 8px 0;
      font-size: 14px;
    }
    input, button {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #bbb;
      font-size: 14px;
    }
    button {
      background: #4a90e2;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover { background: #357abd; }
    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #eee;
      font-size: 13px;
    }
    .progress {
      width: 100%;
      height: 12px;
      background: #eee;
      border-radius: 6px;
      overflow: hidden;
      margin: 8px 0;
    }
    .progress-bar {
      height: 100%;
      background: #4a90e2;
      width: 0%;
      transition: width 0.3s;
    }
    #answerOverlay, #resultOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      z-index: 1000;
      text-align: center;
      padding: 20px;
    }
    #answerOverlay h2 { font-size: 28px; margin-bottom: 16px; }
    #answerOverlay .buttons button { margin: 8px; font-size: 18px; padding: 12px 20px; }
    #resultOverlay.win { background: rgba(0, 128, 0, 0.85); }
    #resultOverlay.lose { background: rgba(128, 0, 0, 0.85); }
    #resultOverlay h1 {
      font-size: 48px;
      animation: pop 1s ease;
    }
    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); }
    }
    .room-list {
      border: 1px solid #ccc;
      border-radius: 8px;
      background: white;
      padding: 12px;
    }
    .room-entry {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
    .room-entry:last-child { border-bottom: none; }
  </style>
</head>
<body>
  <header>20 Domande Multiplayer</header>
  <main>
    <!-- HOME -->
    <section id="home">
      <div class="row">
        <input id="name" placeholder="Il tuo nome" />
        <input id="code" placeholder="Codice stanza (es. ABCD)" />
        <button id="create">Crea (Pensatore)</button>
        <button id="join">Entra</button>
      </div>
      <h3>Stanze attive</h3>
      <div id="rooms" class="room-list">Nessuna stanza attiva</div>
    </section>

    <!-- GAME -->
    <section id="game" class="hidden">
      <div class="row">
        <button id="leave">Esci</button>
        <span>Turno: <span id="turn" class="pill">‚Äì</span></span>
        <span class="pill">Domande: <span id="qcount">0</span>/20</span>
      </div>

      <div id="thinkerControls" class="row hidden">
        <input id="secret" placeholder="Parola segreta" />
        <button id="start">Avvia round</button>
      </div>

      <div id="questionControls" class="row">
        <input id="question" placeholder="Fai una domanda s√¨/no" />
        <button id="ask">Chiedi</button>
        <input id="guess" placeholder="Tenta la risposta" />
        <button id="submitGuess">Indovina</button>
      </div>

      <div class="progress"><div id="progressBar" class="progress-bar"></div></div>

      <div class="log" id="log"></div>
      <div class="chat" id="chat"></div>
      <div class="row">
        <input id="chatInput" placeholder="Scrivi un messaggio..." />
        <button id="chatSend">Invia</button>
      </div>
    </section>
  </main>

  <!-- OVERLAYS -->
  <div id="answerOverlay">
    <h2 id="overlayQuestion"></h2>
    <p>Parola segreta: <strong id="overlaySecret"></strong></p>
    <div class="buttons">
      <button onclick="sendAnswer('S√¨')">S√¨</button>
      <button onclick="sendAnswer('No')">No</button>
      <button onclick="sendAnswer('Non so')">Non so</button>
    </div>
  </div>

  <div id="resultOverlay"><h1 id="resultText"></h1></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let me = { id:null, name:null, role:null, room:null };
    let lastQuestionId = null;

    const $ = id => document.getElementById(id);
    const appendLog = msg => { const d=document.createElement('div'); d.textContent=msg; $('log').appendChild(d); $('log').scrollTop=$('log').scrollHeight; };
    const appendChat = (msg,from) => { const d=document.createElement('div'); d.innerHTML = `<strong>${from}:</strong> ${msg}`; $('chat').appendChild(d); $('chat').scrollTop=$('chat').scrollHeight; };

    function updateProgress(count,max=20){
      $('qcount').textContent = count;
      $('progressBar').style.width = (count/max*100)+'%';
    }

    function sendAnswer(ans){
      if(lastQuestionId){
        socket.emit('question:answer',{ code:me.room,id:lastQuestionId,answer:ans });
        lastQuestionId=null;
        $('answerOverlay').style.display='none';
      }
    }

    // Home
    $('create').onclick=()=>{
      me.name=$('name').value||'Anon';
      me.room=($('code').value||'ABCD').toUpperCase();
      socket.emit('room:create',{ name:me.name, code:me.room });
    };
    $('join').onclick=()=>{
      me.name=$('name').value||'Anon';
      me.room=($('code').value||'ABCD').toUpperCase();
      socket.emit('room:join',{ name:me.name, code:me.room });
    };

    // Game
    $('leave').onclick=()=>{
      socket.emit('room:leave',{ code:me.room });
      me.room=null;
      $('game').classList.add('hidden');
      $('home').classList.remove('hidden');
      $('log').innerHTML='';
      $('chat').innerHTML='';
    };

    $('start').onclick=()=>{
      socket.emit('game:start',{ code:me.room, secret:$('secret').value });
      $('secret').readOnly=true;
      $('start').classList.add('hidden');
    };
    $('ask').onclick=()=>{
      const t=$('question').value.trim();
      if(t) socket.emit('question:ask',{ code:me.room,text:t });
      $('question').value='';
    };
    $('submitGuess').onclick=()=>{
      const t=$('guess').value.trim();
      if(t) socket.emit('guess:try',{ code:me.room,guess:t });
      $('guess').value='';
    };
    $('chatSend').onclick=()=>{
      const t=$('chatInput').value.trim();
      if(t) socket.emit('chat:send',{ code:me.room,text:t });
      $('chatInput').value='';
    };

    // Socket handlers
    socket.on('connect',()=>{ me.id=socket.id; });

    socket.on('rooms:update',list=>{
      if(list.length===0){ $('rooms').textContent='Nessuna stanza attiva'; return; }
      $('rooms').innerHTML='';
      list.forEach(r=>{
        const div=document.createElement('div');
        div.className='room-entry';
        div.innerHTML=`<span>${r.code} (${r.count} giocatori)</span> <button>Entra</button>`;
        div.querySelector('button').onclick=()=>{
          me.name=$('name').value||'Anon';
          me.room=r.code;
          socket.emit('room:join',{ name:me.name, code:r.code });
        };
        $('rooms').appendChild(div);
      });
    });

    socket.on('room:joined',({ code, role })=>{
      me.room=code; me.role=role;
      $('home').classList.add('hidden');
      $('game').classList.remove('hidden');
      if(role==='thinker') $('thinkerControls').classList.remove('hidden');
      else $('thinkerControls').classList.add('hidden');
      $('questionControls').style.display = role==='thinker' ? 'none':'flex';
    });

    socket.on('game:started',({ secretLen })=>{
      appendLog('‚ñ∂Ô∏è Round iniziato! Max 20 domande.');
      $('qcount').textContent=0; updateProgress(0);
      $('secret').readOnly=true;
      $('start').classList.add('hidden');
    });

    socket.on('question:new',q=>{
      appendLog(`‚ùì (${q.byName}) ${q.text}`);
      updateProgress(q.id);
      if(me.role==='thinker'){
        lastQuestionId=q.id;
        $('overlayQuestion').textContent=q.text;
        $('overlaySecret').textContent=$('secret').value;
        $('answerOverlay').style.display='flex';
      }
    });

    socket.on('question:update',q=>{
      appendLog(`üó£Ô∏è Risposta: ${q.answer}`);
    });

    socket.on('turn:now',({ socketId,name })=>{
      $('turn').textContent = socketId===me.id ? 'TU' : (name||'‚Äì');
    });

    socket.on('guess:wrong',g=>{
      appendLog(`üéØ ${g.name} ha tentato "${g.guess}" ‚ùå`);
    });

    socket.on('round:ended',({ message, secretWord, guesser })=>{
      appendLog('üèÅ '+message+` (Parola: ${secretWord})`);
      $('start').classList.remove('hidden');
      $('secret').readOnly=false;
      let win=false;
      if(me.role==='thinker') win=!guesser;
      else win=(guesser===me.id);
      const overlay=$('resultOverlay');
      overlay.className=win?'win':'lose';
      $('resultText').textContent=win?'üéâ Hai vinto!':'üíÄ Hai perso!';
      overlay.style.display='flex';
      setTimeout(()=>overlay.style.display='none',4000);
    });

    socket.on('log',msg=>appendLog(msg));
    socket.on('chat:new',({ from,text })=>appendChat(text,from));
    socket.on('system:error',m=>appendLog('‚ùó '+m));
  </script>
</body>
</html>
