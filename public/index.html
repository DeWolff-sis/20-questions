<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>20Q Multiplayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 24px auto; }
    .row { display:flex; gap:8px; margin:8px 0; flex-wrap: wrap; }
    .log { border:1px solid #ddd; padding:12px; height:300px; overflow:auto; background:#fafafa; }
    .pill { padding:2px 8px; border-radius:999px; border:1px solid #ccc; }
    .chat { border:1px solid #ddd; padding:8px; height:150px; overflow:auto; background:#fff; margin-top:12px; }
    .chat-input { display:flex; gap:8px; margin-top:8px; }
  </style>
</head>
<body>
  <h1>20 Questions (By "The Poker")</h1>
  <div class="row">
    <input id="name" placeholder="Il tuo nome" />
    <input id="code" placeholder="Codice stanza (es. ABCD)" />
    <button id="create">Crea (Pensatore)</button>
    <button id="join">Entra</button>
  </div>

  <div class="row" id="thinker" style="display:none;">
    <input id="secret" placeholder="Parola segreta" />
    <button id="start">Avvia round</button>
  </div>

  <div class="row" id="answerBox" style="display:none;">
    <button onclick="sendAnswer('Sì')">Sì</button>
    <button onclick="sendAnswer('No')">No</button>
    <button onclick="sendAnswer('Non so')">Non so</button>
  </div>

  <div class="row">
    <span>Turno: <span id="turn" class="pill">–</span></span>
    <span class="pill">Domande: <span id="qcount">0</span>/20</span>
  </div>

  <div class="row">
    <input id="question" placeholder="Fai una domanda sì/no" />
    <button id="ask">Chiedi</button>
    <input id="guess" placeholder="Tenta la risposta" />
    <button id="submitGuess">Indovina</button>
  </div>

  <div class="log" id="log"></div>

  <!-- CHAT -->
  <h2>Chat</h2>
  <div class="chat" id="chatLog"></div>
  <div class="chat-input">
    <input id="chatMsg" placeholder="Scrivi un messaggio..." />
    <button id="sendChat">Invia</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let roomCode = null;
    let me = { id: null, name: null, role: null };
    let lastQuestionId = null;
    let questionCount = 0;

    const $ = (id) => document.getElementById(id);
    const log = (msg) => {
      const d = document.createElement('div');
      d.textContent = msg;
      $('log').appendChild(d);
      $('log').scrollTop = $('log').scrollHeight;
    };
    const chatLog = (msg, sender) => {
      const d = document.createElement('div');
      d.innerHTML = `<b>${sender}:</b> ${msg}`;
      $('chatLog').appendChild(d);
      $('chatLog').scrollTop = $('chatLog').scrollHeight;
    };

    function sendAnswer(ans) {
      if (lastQuestionId) {
        socket.emit('question:answer', { code: roomCode, id: lastQuestionId, answer: ans });
        lastQuestionId = null;
        $('answerBox').style.display = 'none';
      }
    }

    $('create').onclick = () => {
      me.name = $('name').value || 'Anon';
      roomCode = ($('code').value || 'ABCD').toUpperCase();
      socket.emit('room:create', { code: roomCode, name: me.name });
    };
    $('join').onclick = () => {
      me.name = $('name').value || 'Anon';
      roomCode = ($('code').value || 'ABCD').toUpperCase();
      socket.emit('room:join', { code: roomCode, name: me.name });
    };
    $('start').onclick = () => socket.emit('round:start', { code: roomCode, secretWord: $('secret').value });
    $('ask').onclick = () => {
      const t = $('question').value.trim();
      if (t) socket.emit('question:ask', { code: roomCode, text: t });
      $('question').value = '';
    };
    $('submitGuess').onclick = () => {
      const t = $('guess').value.trim();
      if (t) socket.emit('guess:submit', { code: roomCode, text: t });
      $('guess').value = '';
    };
    $('sendChat').onclick = () => {
      const t = $('chatMsg').value.trim();
      if (t) {
        socket.emit('chat:message', { code: roomCode, text: t });
        $('chatMsg').value = '';
      }
    };

    socket.on('connect', () => { me.id = socket.id; });
    socket.on('system:error', (m) => log('❗ ' + m));
    socket.on('room:state', (s) => {
      const meEntry = s.players.find(p => p.id === me.id);
      if (meEntry) me.role = meEntry.role;
      $('thinker').style.display = me.role === 'thinker' ? 'flex' : 'none';
      log(`👥 Stanza ${s.code} — giocatori: ${s.players.map(p=>p.name + (p.role==='thinker'?'(P)':'')).join(', ')}`);
    });
    socket.on('round:started', ({ maxQuestions }) => {
      questionCount = 0;
      $('qcount').textContent = 0;
      log('▶️ Round iniziato! Max ' + maxQuestions + ' domande.');
    });
    socket.on('round:secret', ({ secretWord }) => log('🔒 Sei Pensatore. Parola: ' + secretWord));
    socket.on('question:new', (q) => {
      log(`❓ (${q.byName}) ${q.text}`);
      if (me.role === 'thinker') {
        lastQuestionId = q.id;
        $('answerBox').style.display = 'flex';
      }
    });
    socket.on('question:update', (q) => {
      log(`🗣️ Risposta: ${q.answer}`);
      // ✅ aggiorna contatore solo se risposta è Sì o No
      if (q.answer === 'Sì' || q.answer === 'No') {
        questionCount++;
        $('qcount').textContent = questionCount;
      }
    });
    socket.on('turn:now', ({ socketId, name }) => {
      $('turn').textContent = socketId === me.id ? 'TU' : (name || '–');
    });
    socket.on('guess:new', (g) => log(`🎯 ${g.name} ha tentato: "${g.text}" ${g.correct ? '✅' : '❌'}`));
    socket.on('round:ended', ({ message, secretWord }) => {
      log('🏁 ' + message + ` (Parola: ${secretWord})`);
    });

    // CHAT
    socket.on('chat:new', (msg) => {
      chatLog(msg.text, msg.name);
    });
  </script>
</body>
</html>
