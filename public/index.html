<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>20Q Multiplayer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #eef2f3, #dfe9f3);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      max-width: 900px;
      width: 100%;
      margin: 24px;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 16px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 8px 0;
    }

    input, button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    input {
      flex: 1;
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
      transition: background 0.2s;
    }

    button.primary {
      background: #3498db;
      color: white;
    }
    button.primary:hover {
      background: #2980b9;
    }

    button.secondary {
      background: #ecf0f1;
      color: #2c3e50;
    }
    button.secondary:hover {
      background: #d0d7de;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      background: #f0f0f0;
      font-size: 13px;
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0 4px;
      font-weight: 500;
      color: #2c3e50;
    }

    .progress-container {
      width: 100%;
      background: #ecf0f1;
      border-radius: 8px;
      overflow: hidden;
      height: 12px;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #3498db;
      transition: width 0.3s;
    }

    .log {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      height: 200px;
      overflow-y: auto;
      background: #fafafa;
      font-size: 14px;
      margin-top: 12px;
    }

    .chat-box {
      margin-top: 16px;
    }

    @media (max-width: 600px) {
      .row { flex-direction: column; }
      input, button { flex: none; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>20 Domande Multiplayer</h1>

    <div class="row">
      <input id="name" placeholder="Il tuo nome" />
      <input id="code" placeholder="Codice stanza (es. ABCD)" />
      <button id="create" class="primary">Crea (Pensatore)</button>
      <button id="join" class="secondary">Entra</button>
    </div>

    <div class="row" id="thinker" style="display:none;">
      <input id="secret" placeholder="Parola segreta" />
      <button id="start" class="primary">Avvia round</button>
    </div>

    <div class="row" id="answerBox" style="display:none;">
      <button onclick="sendAnswer('S√¨')" class="primary">S√¨</button>
      <button onclick="sendAnswer('No')" class="primary">No</button>
      <button onclick="sendAnswer('Non so')" class="secondary">Non so</button>
    </div>

    <div class="row">
      <span>Turno: <span id="turn" class="pill">‚Äì</span></span>
    </div>

    <div class="progress-header">
      <span>Domande: <span id="qcount">0</span>/<span id="qmax">20</span></span>
    </div>
    <div class="progress-container">
      <div id="progress" class="progress-bar"></div>
    </div>

    <div class="row" id="actionsRow">
      <input id="question" placeholder="Fai una domanda s√¨/no" />
      <button id="ask" class="secondary">‚ùì Chiedi</button>
      <input id="guess" placeholder="Tenta la risposta" />
      <button id="submitGuess" class="primary">üéØ Indovina</button>
    </div>

    <div class="log" id="log"></div>

    <div class="chat-box">
      <h3>üí¨ Chat</h3>
      <div class="log" id="chatLog"></div>
      <div class="row">
        <input id="chatInput" placeholder="Scrivi un messaggio..." />
        <button id="chatSend" class="primary">Invia</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let roomCode = null;
    let me = { id: null, name: null, role: null };
    let lastQuestionId = null;
    let maxQuestions = 20;

    const $ = (id) => document.getElementById(id);
    const log = (msg) => { const d = document.createElement('div'); d.textContent = msg; $('log').appendChild(d); $('log').scrollTop = $('log').scrollHeight; };
    const chatLog = (msg) => { const d = document.createElement('div'); d.textContent = msg; $('chatLog').appendChild(d); $('chatLog').scrollTop = $('chatLog').scrollHeight; };

    function sendAnswer(ans) {
      if (lastQuestionId) {
        socket.emit('question:answer', { code: roomCode, id: lastQuestionId, answer: ans });
        lastQuestionId = null;
        $('answerBox').style.display = 'none';
      }
    }

    function updateProgress(count) {
      $('qcount').textContent = count;
      const pct = Math.min(100, (count / maxQuestions) * 100);
      $('progress').style.width = pct + '%';
    }

    $('create').onclick = () => {
      me.name = $('name').value || 'Anon';
      roomCode = ($('code').value || 'ABCD').toUpperCase();
      socket.emit('room:create', { code: roomCode, name: me.name });
    };
    $('join').onclick = () => {
      me.name = $('name').value || 'Anon';
      roomCode = ($('code').value || 'ABCD').toUpperCase();
      socket.emit('room:join', { code: roomCode, name: me.name });
    };
    $('start').onclick = () => socket.emit('round:start', { code: roomCode, secretWord: $('secret').value });
    $('ask').onclick = () => { const t = $('question').value.trim(); if (t) socket.emit('question:ask', { code: roomCode, text: t }); $('question').value = ''; };
    $('submitGuess').onclick = () => { const t = $('guess').value.trim(); if (t) socket.emit('guess:submit', { code: roomCode, text: t }); $('guess').value = ''; };

    $('chatSend').onclick = () => {
      const msg = $('chatInput').value.trim();
      if (msg) {
        socket.emit('chat:message', { code: roomCode, name: me.name, text: msg });
        $('chatInput').value = '';
      }
    };

    socket.on('connect', () => { me.id = socket.id; });
    socket.on('system:error', (m) => log('‚ùó ' + m));
    socket.on('room:state', (s) => {
      const meEntry = s.players.find(p => p.id === me.id);
      if (meEntry) me.role = meEntry.role;
      $('thinker').style.display = me.role === 'thinker' ? 'flex' : 'none';
      $('actionsRow').style.display = me.role === 'thinker' ? 'none' : 'flex';
      log(`üë• Stanza ${s.code} ‚Äî giocatori: ${s.players.map(p=>p.name + (p.role==='thinker'?'(P)':'')).join(', ')}`);
    });
    socket.on('round:started', ({ maxQuestions: mq }) => {
      maxQuestions = mq;
      $('qmax').textContent = mq;
      updateProgress(0);
      $('start').style.display = 'none';
      log('‚ñ∂Ô∏è Round iniziato! Max ' + mq + ' domande.');
    });
    socket.on('round:secret', ({ secretWord }) => log('üîí Sei Pensatore. Parola: ' + secretWord));
    socket.on('question:new', (q) => {
      updateProgress(q.id);
      log(`‚ùì (${q.byName}) ${q.text}`);
      if (me.role === 'thinker') {
        lastQuestionId = q.id;
        $('answerBox').style.display = 'flex';
      }
    });
    socket.on('question:update', (q) => {
      log(`üó£Ô∏è Risposta: ${q.answer}`);
    });
    socket.on('turn:now', ({ socketId, name }) => {
      $('turn').textContent = socketId === me.id ? 'TU' : (name || '‚Äì');
    });
    socket.on('guess:new', (g) => {
      log(`üéØ ${g.name} ha tentato: "${g.text}" ${g.correct ? '‚úÖ' : '‚ùå'}`);
      const current = parseInt($('qcount').textContent);
      updateProgress(current + 1);
    });
    socket.on('round:ended', ({ message, secretWord }) => {
      log('üèÅ ' + message + ` (Parola: ${secretWord})`);
      $('start').style.display = 'inline-block';
    });

    socket.on('chat:message', ({ name, text }) => {
      chatLog(`${name}: ${text}`);
    });
  </script>
</body>
</html>
